<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVix Vulnerability Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col">

    <header class="bg-slate-800 text-teal-400 shadow-md p-6 flex justify-center items-center">
        <div class="flex flex-col items-center">
            <h1 class="text-4xl font-extrabold tracking-tight">CVix Vulnerability Tracker</h1>
            <p class="mt-2 text-lg text-slate-400">
                real time vulnerability list.
            </p>
        </div>
    </header>

    <main class="flex-1 container mx-auto p-8 flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8">
        
        <aside class="w-full md:w-1/3 lg:w-1/4 p-6 bg-slate-800 rounded-lg shadow-lg border border-teal-500/20 h-fit">
            <h2 class="text-2xl font-bold text-teal-400 mb-4">Top 5 Highlights</h2>
            <ul id="sidebar-list" class="space-y-4"></ul>
        </aside>

        <section class="flex-1">
            <div id="vulnerability-list-section">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
                    <button id="refresh-button" class="bg-teal-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-teal-700 transition duration-300 transform hover:scale-105">
                        Refresh Data
                    </button>
                    <div class="relative w-full sm:w-1/2">
                        <input type="text" id="search-input" placeholder="Search by name or affected product..." class="w-full pl-10 pr-4 py-2 rounded-full bg-slate-900 border border-slate-700 text-slate-200 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                <div id="loading" class="text-center text-slate-400 text-lg mt-10 hidden">
                    Loading vulnerabilities...
                </div>
                <div id="error-message" class="text-center text-red-500 font-semibold mt-10 hidden">
                    Failed to load data.
                </div>
                <div id="vulnerability-list" class="grid gap-6 mt-8"></div>
            </div>

            <div id="vulnerability-details-section" class="hidden">
                <button id="back-button" class="text-teal-400 hover:text-teal-600 mb-4 font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to List
                </button>
                <div id="details-content" class="bg-slate-800 p-8 rounded-lg border border-teal-500/20">
                    <p class="text-center text-slate-400">Loading details...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        const vulnerabilityListSection = document.getElementById('vulnerability-list-section');
        const vulnerabilityDetailsSection = document.getElementById('vulnerability-details-section');
        const vulnerabilityList = document.getElementById('vulnerability-list');
        const sidebarList = document.getElementById('sidebar-list');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const refreshButton = document.getElementById('refresh-button');
        const searchInput = document.getElementById('search-input');
        const backButton = document.getElementById('back-button');
        const detailsContent = document.getElementById('details-content');

        let allVulnerabilities = [];

        function getPriorityColor(priority) {
            switch (priority) {
                case 'Critical': return 'bg-red-500/30 text-red-300';
                case 'High': return 'bg-orange-500/30 text-orange-300';
                case 'Medium': return 'bg-yellow-500/30 text-yellow-300';
                default: return 'bg-slate-500/30 text-slate-300';
            }
        }

        async function showDetails(vulnerability) {
            vulnerabilityListSection.classList.add('hidden');
            vulnerabilityDetailsSection.classList.remove('hidden');
            detailsContent.innerHTML = `<p class="text-center text-slate-400">Loading details...</p>`;

            try {
                const prompt = `Provide a detailed, technical explanation of the vulnerability with the following information: Vulnerability Name: ${vulnerability.name}, Affected Products: ${vulnerability.affected}, CVE ID: ${vulnerability.cveID}, Required Action: ${vulnerability.requiredAction}. The explanation should cover:
                1. A brief, high-level summary of the vulnerability.
                2. Technical details of how the vulnerability works.
                3. The potential impact of the vulnerability.
                4. Recommended mitigation steps.
                Format the response using Markdown. Do not include any introductory or concluding remarks outside of the Markdown content.`;

                const response = await fetch('http://127.0.0.1:5000/api/generate_vulnerability_details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                
                const markdownContent = data.text;
                detailsContent.innerHTML = `
                    <h3 class="text-3xl font-bold text-teal-400 mb-4">${vulnerability.name}</h3>
                    <p class="text-slate-400 text-sm mb-2"><strong>CVE ID:</strong> ${vulnerability.cveID}</p>
                    <p class="text-slate-400 mb-4"><strong>Affected Products:</strong> ${vulnerability.affected}</p>
                    <div class="mb-4">
                        <span class="inline-block ${getPriorityColor(vulnerability.priority)} text-sm font-semibold px-3 py-1 rounded-full">
                            ${vulnerability.priority}
                        </span>
                        <span class="inline-block bg-slate-500/30 text-slate-300 text-sm font-semibold px-3 py-1 rounded-full ml-2">
                            ${vulnerability.type}
                        </span>
                    </div>
                    <hr class="border-slate-700 mb-6">
                    <div class="prose prose-invert max-w-none text-slate-300">
                        <pre class="bg-slate-700 p-4 rounded-md overflow-x-auto whitespace-pre-wrap"><code class="text-sm">${markdownContent}</code></pre>
                    </div>
                `;

            } catch (error) {
                console.error("Error fetching AI-generated details:", error);
                
                detailsContent.innerHTML = `
                    <h3 class="text-3xl font-bold text-teal-400 mb-4">AI Details Unavailable</h3>
                    <p class="text-center text-red-400 mb-6">Failed to load detailed information from the AI. Showing fallback data instead.</p>
                    <div class="bg-slate-700 p-6 rounded-lg">
                        <p class="text-slate-300 font-semibold">Required Action:</p>
                        <p class="text-slate-400 mt-2">${vulnerability.requiredAction}</p>
                        <p class="text-slate-300 font-semibold mt-4">Notes:</p>
                        <p class="text-slate-400 mt-2">${vulnerability.notes}</p>
                    </div>
                `;
            }
        }
        
        function createVulnerabilityCard(vulnerability) {
            const card = document.createElement('div');
            card.className = 'card bg-slate-800 p-6 rounded-lg border border-slate-700 flex flex-col md:flex-row items-start md:items-center justify-between space-y-4 md:space-y-0 md:space-x-6 cursor-pointer hover:bg-slate-700';
            
            const priorityColorClass = getPriorityColor(vulnerability.priority);
            
            card.innerHTML = `
                <div class="flex-grow">
                    <h2 class="text-xl font-bold text-sky-400">${vulnerability.name}</h2>
                    <p class="mt-1 text-slate-400">
                        <span class="font-semibold">Affected:</span> ${vulnerability.affected}
                    </p>
                    <p class="mt-1 text-slate-400">
                        <span class="font-semibold">Last Updated:</span> ${vulnerability.dateAdded}
                    </p>
                </div>
                <div class="flex-shrink-0 text-center md:text-right mt-4 md:mt-0">
                    <span class="inline-block ${priorityColorClass} text-sm font-semibold px-3 py-1 rounded-full">
                        ${vulnerability.priority}
                    </span>
                    <p class="text-sm text-slate-500 mt-2">${vulnerability.cveID}</p>
                </div>
            `;
            
            card.addEventListener('click', () => showDetails(vulnerability));
            return card;
        }

        function createSidebarItem(vulnerability) {
            const item = document.createElement('li');
            item.className = 'p-4 bg-slate-700 rounded-lg shadow-inner border border-teal-500/20 transition-colors hover:bg-slate-600 cursor-pointer';

            item.innerHTML = `
                <h4 class="font-semibold text-lime-400">${vulnerability.name}</h4>
                <p class="text-xs text-slate-400 mt-1">${vulnerability.cveID}</p>
            `;
            item.addEventListener('click', () => showDetails(vulnerability));
            return item;
        }

        async function fetchVulnerabilities() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            vulnerabilityList.innerHTML = '';
            sidebarList.innerHTML = '';
            searchInput.value = '';

            try {
                const response = await fetch('http://127.0.0.1:5000/api/vulnerabilities');
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received.");
                }
                allVulnerabilities = data;
                
                displayVulnerabilities(allVulnerabilities);
                
                const highlights = allVulnerabilities.slice(0, 5);
                highlights.forEach(vulnerability => {
                    sidebarList.appendChild(createSidebarItem(vulnerability));
                });
                
            } catch (error) {
                console.error("Error fetching vulnerabilities:", error);
                errorMessage.textContent = `Failed to load data. Details: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function displayVulnerabilities(vulnerabilities) {
            vulnerabilityList.innerHTML = '';
            if (vulnerabilities.length === 0) {
                vulnerabilityList.innerHTML = `<p class="text-center text-slate-400 text-lg">No vulnerabilities found.</p>`;
                return;
            }

            vulnerabilities.forEach(vulnerability => {
                vulnerabilityList.appendChild(createVulnerabilityCard(vulnerability));
            });
        }

        function handleSearch(event) {
            const query = event.target.value.toLowerCase();
            const filteredVulnerabilities = allVulnerabilities.filter(vuln => {
                return vuln.name.toLowerCase().includes(query) || vuln.affected.toLowerCase().includes(query) || vuln.cveID.toLowerCase().includes(query);
            });
            displayVulnerabilities(filteredVulnerabilities);
        }

        backButton.addEventListener('click', () => {
            vulnerabilityDetailsSection.classList.add('hidden');
            vulnerabilityListSection.classList.remove('hidden');
            displayVulnerabilities(allVulnerabilities);
        });

        refreshButton.addEventListener('click', fetchVulnerabilities);
        searchInput.addEventListener('input', handleSearch);

        window.onload = fetchVulnerabilities;
    </script>
</body>
</html>
